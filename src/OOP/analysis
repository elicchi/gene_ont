import numpy as np

import numpy as np

def build_annotation_matrix(gaf):
    annotations = gaf.annotations

    genes = list({ann.gene_id for ann in annotations})
    terms = list({ann.GOterm.ID for ann in annotations})

    # create index maps for fast lookup
    gene_idx = {gene: i for i, gene in enumerate(genes)}
    term_idx = {term: j for j, term in enumerate(terms)}

    matrix = np.zeros((len(genes), len(terms)), dtype=int)

    # fill matrix efficiently
    for ann in annotations:
        i = gene_idx[ann.gene_id]
        j = term_idx[ann.GOterm.ID]
        matrix[i, j] = 1

    return matrix, genes, terms


def count_terms_per_gene(matrix, genes):
    return {genes[i]: int(np.sum(matrix[i])) for i in range(len(genes))}

def term_frequencies(matrix, terms):
    return {terms[j]: int(np.sum(matrix[:, j])) for j in range(len(terms))}

def build_matrix_for_category(gaf, category):
    filtered = [ann for ann in gaf.annotations if ann.category() == category]
    temp_gaf = GAF()
    for ann in filtered:
        temp_gaf.add_annotation(ann)
    return build_annotation_matrix(temp_gaf)
